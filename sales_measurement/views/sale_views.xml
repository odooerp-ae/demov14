<?xml version="1.0" encoding="utf-8"?>

<odoo>
    <record id="view_order_form" model="ir.ui.view">
        <field name="name">sale.order.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <div class="oe_title" position="before">
                <field name="is_final_approve" invisible="1"/>
                <widget name="web_ribbon" title="Final Approved"
                        bg_color="bg-info"
                        attrs="{'invisible': [('is_final_approve', '=', False)]}"/>
            </div>
            <div name="button_box" position="inside">
                <button class="oe_stat_button" name="action_view_payments"
                        string="Payments" type="object"
                        widget="statinfo" icon="fa-usd"/>
            </div>

            <xpath expr="//header" position="inside">

                <button name="action_so_register_payment" id="account_invoice_payment_btn"
                        type="object" class="oe_highlight" string="Register Payment"
                        attrs="{'invisible': [('state', 'in', ('done', 'cancel', 'rejected'))]}"
                />
                <button name="action_set_to_final_measurement" id="action_set_to_final_measurement"
                        type="object" class="oe_highlight" string="Final Measurement"
                        attrs="{'invisible': [('state', 'not in', ['advance_payment'])]}"
                />
                <button name="action_final_approve" id="action_final_approve"
                        type="object" class="oe_highlight" string="Final Approve"
                        attrs="{'invisible': ['|', ('is_final_approve', '=', True),('state', 'in', ['draft','sent','cancel', 'rejected'])]}"
                />
                <button name="%(sale_order_reject_wizard_action)d"
                        string="Reject" context="{'default_sale_order_id': active_id}"
                        attrs="{'invisible': [('state', 'not in', ['draft', 'sent',  'rejected'])]}"
                        type="action"/>

            </xpath>
            <xpath expr="//button[@name='action_cancel']" position="attributes">
                <attribute name="attrs">{'invisible': [('state', 'in', ['draft', 'sent', 'rejected', 'cancel'])]}</attribute>
            </xpath>
            <xpath expr="//button[@name='action_confirm'][1]" position="attributes">
                <attribute name="attrs">{'invisible': ['|','|', ('is_auto_confirm', '=', True),('is_confirmed', '=', True),('state', 'not in', ['final_measurement', 'production_payment', 'payment_finalize'])]}</attribute>
            </xpath>
            <xpath expr="//button[@name='action_confirm'][2]" position="attributes">
                <attribute name="attrs">{'invisible': True}</attribute>
            </xpath>
            <xpath expr="//button[@name='%(sale.action_view_sale_advance_payment_inv)d']" position="attributes">
                <attribute name="attrs">{'invisible': [('state', 'not in', ['production_payment','payment_finalize'])]}</attribute>
            </xpath>
            <xpath expr="//field[@name='payment_term_id']" position="after">
                <field name="planned_final_measurement_date" attrs="{'required': [('state', 'not in', ['draft', 'sent'])]}"/>
                <field name="actual_final_measurement_date" attrs="{'readonly':True, 'invisible': [('state','not in', ['final_measurement','production_payment','payment_finalize'])]}"/>
                <field name="final_approve_date" attrs="{'readonly':True}"/>
            </xpath>
            <xpath expr="//field[@name='tag_ids']" position="after">
                <field name="quotation_ref" readonly="1" />
                <field name="measure_request_id" readonly="1"/>
                <field name="is_auto_confirm" invisible="1"/>
                <field name="last_state" invisible="1"/>
                <field name="is_confirmed" invisible="1"/>
            </xpath>
            <xpath expr="//field[@name='amount_total']" position="after">
                <field name="paid_amount" readonly="1"/>
                <field name="unpaid_amount" readonly="1"/>
                <field name="paid_amount_percent" readonly="1"/>
            </xpath>

            <xpath expr="//page[last()]" position="after">
                <page name="reject_reason" string="Reject Reason"
                      attrs="{'invisible':[('state','!=','rejected')],'readonly': True}">
                    <group>
                        <group>
                            <field name="reject_reason_id"
                                   attrs="{'invisible':[('state','!=','rejected')],'readonly':True}"/>
                        </group>
                        <group>
                        </group>

                    </group>
                </page>
            </xpath>

        </field>
    </record>

    <record id="view_quotation_tree_with_onboarding" model="ir.ui.view">
        <field name="name">sale.order</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree_with_onboarding"/>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='name']" position="replace">
                <field name="quotation_ref" />
            </xpath>

        </field>
    </record>

    <record id="view_quotation_tree" model="ir.ui.view">
        <field name="name">sale.order</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='amount_total']" position="after">
                <field name="paid_amount" optional="show"/>
                <field name="unpaid_amount" optional="show"/>
                <field name="paid_amount_percent" optional="show"/>
            </xpath>

        </field>
    </record>

    <record id="view_order_tree" model="ir.ui.view">
        <field name="name">sale.order</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='amount_total']" position="after">
                <field name="paid_amount" optional="show"/>
                <field name="unpaid_amount" optional="show"/>
                <field name="paid_amount_percent" optional="show"/>
            </xpath>

        </field>
    </record>

    <record id="sale.action_orders" model="ir.actions.act_window">
        <field name="name">Contracts</field>
        <field name="domain">[('state', 'not in', ('rejected', 'draft', 'sent'))]</field>
    </record>

    <record id="sale.action_quotations_with_onboarding" model="ir.actions.act_window">
        <field name="domain">[]</field>
    </record>

    <record model="ir.ui.menu" id="sale.menu_sale_order">
        <field name="name">Contracts</field>
    </record>

    <record id="view_final_measurement_order_tree" model="ir.ui.view">
        <field name="name">sale.order</field>
        <field name="model">sale.order</field>
        <field name="mode">primary</field>
        <field name="priority">1000</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='invoice_status']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_status']" position="after">
                <field name="planned_final_measurement_date" />
                <field name="actual_final_measurement_date" />
            </xpath>
        </field>
    </record>

    <record id="action_final_measurement_orders" model="ir.actions.act_window">
        <field name="name">Final Measurement</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('state', 'in', ['final_measurement','advance_payment'])]</field>
         <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('view_final_measurement_order_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('sale.view_order_form')})]"/>

        <field name="help" type="html">
          <p class="oe_view_nocontent_create">
            <!-- Add Text Here -->
          </p><p>
            <!-- More details about what a user can do with this object will be OK -->
          </p>
        </field>
    </record>

    <menuitem id="final_measurement_orders"
              name="Final Measurement"
              parent="sale.sale_order_menu"
              action="action_final_measurement_orders" sequence="100"/>

</odoo>